
<!DOCTYPE html>


<html lang="en" data-content_root="../" data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>System Config &#8212; xNVMe v0.7.4 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/theme_overrides.css?v=70f28cd9" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/jquery.js?v=5d32c60e"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../_static/documentation_options.js?v=f9b80c38"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'backends/system';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.15.2';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://xnvme.io/versions.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = 'v0.7.4';
        DOCUMENTATION_OPTIONS.show_version_warning_banner = true;
        </script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Tools" href="../tools/index.html" />
    <link rel="prev" title="Backend Interface" href="xnvme_be_intf.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class=" navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
    
    <img src="../_static/xnvme.svg" class="logo__image only-light" alt="xNVMe v0.7.4 documentation - Home"/>
    <script>document.write(`<img src="../_static/xnvme.svg" class="logo__image only-dark" alt="xNVMe v0.7.4 documentation - Home"/>`);</script>
  
  
</a></div>
    
  </div>
  
  <div class=" navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../getting_started/index.html">
                        Getting Started
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        Backends
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../tools/index.html">
                        Tools
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../api/index.html">
                        API
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../tutorial/index.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../material/index.html">
                        Material
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../contributing/index.html">
                        Contributing
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-2"
      type="button"
      class="version-switcher__button btn btn-sm navbar-btn dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-2"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-2"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-2">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../getting_started/index.html">
                        Getting Started
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        Backends
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../tools/index.html">
                        Tools
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../api/index.html">
                        API
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../tutorial/index.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../material/index.html">
                        Material
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../contributing/index.html">
                        Contributing
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-3"
      type="button"
      class="version-switcher__button btn btn-sm navbar-btn dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-3"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-3"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-3">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="xnvme_be_linux.html">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="xnvme_be_fbsd.html">FreeBSD</a></li>
<li class="toctree-l1"><a class="reference internal" href="xnvme_be_spdk/index.html">SPDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="xnvme_be_windows.html">Windows</a></li>
<li class="toctree-l1"><a class="reference internal" href="xnvme_be_intf.html">Backend Interface</a></li>

<li class="toctree-l1 current active"><a class="current reference internal" href="#">System Config</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">Backends</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">System Config</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="system-config">
<span id="sec-gs-system-config"></span><h1>System Config<a class="headerlink" href="#system-config" title="Link to this heading">#</a></h1>
<p><strong>xNVMe</strong> relies on certain Operating System Kernel features and infrastructure
that must be available and correctly configured. This subsection goes through
what is used on Linux and how check whether is it available.</p>
<section id="backends">
<h2>Backends<a class="headerlink" href="#backends" title="Link to this heading">#</a></h2>
<p>The purpose of <strong>xNVMe</strong> backends are to provide an instrumental runtime
supporting the <strong>xNVMe</strong> API in a single library with <strong>batteries included</strong>.</p>
<p>That is, it comes with the essential third-party libraries bundled into the
<strong>xNVMe</strong> library. Thus, you get a single C API to program against and a single
library to link with. And similarly for the command-line tools; a single binary
to communicating with devices via the I/O stacks that available on the system.</p>
<p>To inspect the libraries which <strong>xNVMe</strong> is build against and the
supported/enabled backends then invoke:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>xnvme<span class="w"> </span>library-info
</pre></div>
</div>
<p>It should produce output similar to:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># xNVMe Library Information</span>
ver:<span class="w"> </span><span class="o">{</span>major:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>minor:<span class="w"> </span><span class="m">4</span>,<span class="w"> </span>patch:<span class="w"> </span><span class="m">0</span><span class="o">}</span>
xnvme_libconf:
<span class="w">  </span>-<span class="w"> </span><span class="s1">&#39;3p: fio;git-describe:fio-3.30&#39;</span>
<span class="w">  </span>-<span class="w"> </span><span class="s1">&#39;3p: liburing;git-describe:liburing-2.1-460-g4633a2d0&#39;</span>
<span class="w">  </span>-<span class="w"> </span><span class="s1">&#39;3p: spdk;git-describe:v21.10;+patches&#39;</span>
<span class="w">  </span>-<span class="w"> </span><span class="s1">&#39;conf: XNVME_BE_LINUX_ENABLED&#39;</span>
<span class="w">  </span>-<span class="w"> </span><span class="s1">&#39;conf: XNVME_BE_LINUX_BLOCK_ENABLED&#39;</span>
<span class="w">  </span>-<span class="w"> </span><span class="s1">&#39;conf: XNVME_BE_LINUX_BLOCK_ZONED_ENABLED&#39;</span>
<span class="w">  </span>-<span class="w"> </span><span class="s1">&#39;conf: XNVME_BE_LINUX_LIBAIO_ENABLED&#39;</span>
<span class="w">  </span>-<span class="w"> </span><span class="s1">&#39;conf: XNVME_BE_LINUX_LIBURING_ENABLED&#39;</span>
<span class="w">  </span>-<span class="w"> </span><span class="s1">&#39;conf: XNVME_BE_POSIX_ENABLED&#39;</span>
<span class="w">  </span>-<span class="w"> </span><span class="s1">&#39;conf: XNVME_BE_SPDK_ENABLED&#39;</span>
<span class="w">  </span>-<span class="w"> </span><span class="s1">&#39;conf: XNVME_BE_SPDK_TRANSPORT_PCIE_ENABLED&#39;</span>
<span class="w">  </span>-<span class="w"> </span><span class="s1">&#39;conf: XNVME_BE_SPDK_TRANSPORT_TCP_ENABLED&#39;</span>
<span class="w">  </span>-<span class="w"> </span><span class="s1">&#39;conf: XNVME_BE_SPDK_TRANSPORT_RDMA_ENABLED&#39;</span>
<span class="w">  </span>-<span class="w"> </span><span class="s1">&#39;conf: XNVME_BE_SPDK_TRANSPORT_FC_ENABLED&#39;</span>
<span class="w">  </span>-<span class="w"> </span><span class="s1">&#39;conf: XNVME_BE_ASYNC_ENABLED&#39;</span>
<span class="w">  </span>-<span class="w"> </span><span class="s1">&#39;conf: XNVME_BE_ASYNC_EMU_ENABLED&#39;</span>
<span class="w">  </span>-<span class="w"> </span><span class="s1">&#39;conf: XNVME_BE_ASYNC_THRPOOL_ENABLED&#39;</span>
<span class="w">  </span>-<span class="w"> </span><span class="s1">&#39;3p: linux;LINUX_VERSION_CODE-UAPI/330332-5.10.92&#39;</span>
<span class="w">  </span>-<span class="w"> </span><span class="s1">&#39;3p: NVME_IOCTL_IO64_CMD&#39;</span>
<span class="w">  </span>-<span class="w"> </span><span class="s1">&#39;3p: NVME_IOCTL_ADMIN64_CMD&#39;</span>
xnvme_be_attr_list:
<span class="w">  </span>count:<span class="w"> </span><span class="m">5</span>
<span class="w">  </span>capacity:<span class="w"> </span><span class="m">5</span>
<span class="w">  </span>items:
<span class="w">  </span>-<span class="w"> </span>name:<span class="w"> </span><span class="s1">&#39;spdk&#39;</span>
<span class="w">    </span>enabled:<span class="w"> </span><span class="m">1</span>

<span class="w">  </span>-<span class="w"> </span>name:<span class="w"> </span><span class="s1">&#39;linux&#39;</span>
<span class="w">    </span>enabled:<span class="w"> </span><span class="m">1</span>

<span class="w">  </span>-<span class="w"> </span>name:<span class="w"> </span><span class="s1">&#39;fbsd&#39;</span>
<span class="w">    </span>enabled:<span class="w"> </span><span class="m">0</span>

<span class="w">  </span>-<span class="w"> </span>name:<span class="w"> </span><span class="s1">&#39;posix&#39;</span>
<span class="w">    </span>enabled:<span class="w"> </span><span class="m">1</span>

<span class="w">  </span>-<span class="w"> </span>name:<span class="w"> </span><span class="s1">&#39;windows&#39;</span>
<span class="w">    </span>enabled:<span class="w"> </span><span class="m">0</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">xnvme_3p</span></code> part of the output informs about the third-party projects
which <strong>xNVMe</strong> was built against, and in the case of libraries, the version it
has bundled.</p>
<p>Although a single API and a single library is provided by <strong>xNVMe</strong>, then
runtime and system configuration dependencies remain. The following subsections
describe how to instrument <strong>xNVMe</strong> to utilize the different kernel interfaces
and user space drivers.</p>
</section>
<section id="kernel">
<h2>Kernel<a class="headerlink" href="#kernel" title="Link to this heading">#</a></h2>
<p>Linux Kernel version 5.9 or newer is currently preferred as it has all the
features which <strong>xNVMe</strong> utilizes. This section also gives you a brief overview
of the different I/O paths and APIs which the <strong>xNVMe</strong> API unifies access to.</p>
<section id="nvme-driver-and-ioctls">
<h3>NVMe Driver and IOCTLs<a class="headerlink" href="#nvme-driver-and-ioctls" title="Link to this heading">#</a></h3>
<p>The default for <strong>xNVMe</strong> is to communicate with devices via the operating
system NVMe driver IOCTLs, specifically on Linux the following are used:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">NVME_IOCTL_ID</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NVME_IOCTL_IO_CMD</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NVME_IOCTL_ADMIN_CMD</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NVME_IOCTL_IO64_CMD</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NVME_IOCTL_ADMIN64_CMD</span></code></p></li>
</ul>
<p>In case the <code class="docutils literal notranslate"><span class="pre">*64_CMD</span></code> IOCTLs are not available then <strong>xNVMe</strong> falls back to
using the non-64bit equivalents. The 64 vs 32 completion result mostly affect
commands such as Zone Append. You can check that this interface is behaving as
expected by running:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>xnvme<span class="w"> </span>info<span class="w"> </span>/dev/nvme0n1
</pre></div>
</div>
<p>Which you yield output equivalent to:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>xnvme_dev:
<span class="w">  </span>xnvme_ident:
<span class="w">    </span>uri:<span class="w"> </span><span class="s1">&#39;/dev/nvme0n1&#39;</span>
<span class="w">    </span>dtype:<span class="w"> </span>0x2
<span class="w">    </span>nsid:<span class="w"> </span>0x1
<span class="w">    </span>csi:<span class="w"> </span>0x0
<span class="w">  </span>xnvme_be:
<span class="w">    </span>admin:<span class="w"> </span><span class="o">{</span>id:<span class="w"> </span><span class="s1">&#39;nvme&#39;</span><span class="o">}</span>
<span class="w">    </span>sync:<span class="w"> </span><span class="o">{</span>id:<span class="w"> </span><span class="s1">&#39;nvme&#39;</span><span class="o">}</span>
<span class="w">    </span>async:<span class="w"> </span><span class="o">{</span>id:<span class="w"> </span><span class="s1">&#39;emu&#39;</span><span class="o">}</span>
</pre></div>
</div>
<p>This tells you that <strong>xNVMe</strong> can communicate with the given device identifier
and it informs you that it utilizes <strong>nvme_ioctl</strong> for synchronous command
execution and it uses <strong>thr</strong> for asynchronous command execution.  Since IOCTLs
are inherently synchronous then <strong>xNVMe</strong> mimics asynchronous behavior over
IOCTLs to support the asynchronous primitives provided by the <strong>xNVMe</strong> API.</p>
</section>
<section id="block-layer">
<h3>Block Layer<a class="headerlink" href="#block-layer" title="Link to this heading">#</a></h3>
<p>In case your device is <strong>not</strong> an NVMe device, then the NVMe IOCTLs wonâ€™t be
available. <strong>xNVMe</strong> will then try to utilize the Linux Block Layer and treat
a given block device as a NVMe device via shim-layer for NVMe admin commands
such as identify and get-features.</p>
<p>A brief example of checking this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a NULL Block instance</span>
modprobe<span class="w"> </span>null_blk<span class="w"> </span><span class="nv">nr_devices</span><span class="o">=</span><span class="m">1</span>
<span class="c1"># Open and query the NULL Block instance with xNVMe</span>
xnvme<span class="w"> </span>info<span class="w"> </span>/dev/nullb0
<span class="c1"># Remove the NULL Block instance</span>
modprobe<span class="w"> </span>-r<span class="w"> </span>null_blk
</pre></div>
</div>
<p>Yielding:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>xnvme_dev:
<span class="w">  </span>xnvme_ident:
<span class="w">    </span>uri:<span class="w"> </span><span class="s1">&#39;/dev/nullb0&#39;</span>
<span class="w">    </span>dtype:<span class="w"> </span>0x3
<span class="w">    </span>nsid:<span class="w"> </span>0x1
<span class="w">    </span>csi:<span class="w"> </span>0x1f
<span class="w">  </span>xnvme_be:
<span class="w">    </span>admin:<span class="w"> </span><span class="o">{</span>id:<span class="w"> </span><span class="s1">&#39;block&#39;</span><span class="o">}</span>
<span class="w">    </span>sync:<span class="w"> </span><span class="o">{</span>id:<span class="w"> </span><span class="s1">&#39;block&#39;</span><span class="o">}</span>
<span class="w">    </span>async:<span class="w"> </span><span class="o">{</span>id:<span class="w"> </span><span class="s1">&#39;emu&#39;</span><span class="o">}</span>
<span class="w">    </span>attr:<span class="w"> </span><span class="o">{</span>name:<span class="w"> </span><span class="s1">&#39;linux&#39;</span><span class="o">}</span>
<span class="w">  </span>xnvme_opts:
<span class="w">    </span>be:<span class="w"> </span><span class="s1">&#39;linux&#39;</span>
<span class="w">    </span>mem:<span class="w"> </span><span class="s1">&#39;FIX-ID-VS-MIXIN-NAME&#39;</span>
<span class="w">    </span>dev:<span class="w"> </span><span class="s1">&#39;FIX-ID-VS-MIXIN-NAME&#39;</span>
<span class="w">    </span>admin:<span class="w"> </span><span class="s1">&#39;block&#39;</span>
<span class="w">    </span>sync:<span class="w"> </span><span class="s1">&#39;block&#39;</span>
<span class="w">    </span>async:<span class="w"> </span><span class="s1">&#39;emu&#39;</span>
<span class="w">    </span>oflags:<span class="w"> </span>0x4
<span class="w">  </span>xnvme_geo:
<span class="w">    </span>type:<span class="w"> </span>XNVME_GEO_CONVENTIONAL
<span class="w">    </span>npugrp:<span class="w"> </span><span class="m">1</span>
<span class="w">    </span>npunit:<span class="w"> </span><span class="m">1</span>
<span class="w">    </span>nzone:<span class="w"> </span><span class="m">1</span>
<span class="w">    </span>nsect:<span class="w"> </span><span class="m">524288000</span>
<span class="w">    </span>nbytes:<span class="w"> </span><span class="m">512</span>
<span class="w">    </span>nbytes_oob:<span class="w"> </span><span class="m">0</span>
<span class="w">    </span>tbytes:<span class="w"> </span><span class="m">268435456000</span>
<span class="w">    </span>mdts_nbytes:<span class="w"> </span><span class="m">65024</span>
<span class="w">    </span>lba_nbytes:<span class="w"> </span><span class="m">512</span>
<span class="w">    </span>lba_extended:<span class="w"> </span><span class="m">0</span>
<span class="w">    </span>ssw:<span class="w"> </span><span class="m">9</span>
</pre></div>
</div>
</section>
<section id="block-zoned-ioctls">
<h3>Block Zoned IOCTLs<a class="headerlink" href="#block-zoned-ioctls" title="Link to this heading">#</a></h3>
<p>Building on the Linux Block model, then the Zoned Block Device model is also
utilized, specifically the following IOCTLs:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">BLK_ZONE_REP_CAPACITY</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BLKCLOSEZONE</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BLKFINISHZONE</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BLKOPENZONE</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BLKRESETZONE</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BLKGETNRZONES</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BLKREPORTZONE</span></code></p></li>
</ul>
<p>When available, then <strong>xNVMe</strong> can make use of the above IOCTLs. This is
mostly useful when developing/testing using Linux Null Block devices.
And similar for a Zoned NULL Block instance:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a Zoned NULL Block instance</span>
modprobe<span class="w"> </span>null_blk<span class="w"> </span><span class="nv">nr_devices</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">zoned</span><span class="o">=</span><span class="m">1</span>
<span class="c1"># Open and query the Zoned NULL Block instance with xNVMe</span>
xnvme<span class="w"> </span>info<span class="w"> </span>/dev/nullb0
<span class="c1"># Remove the Zoned NULL Block instance</span>
modprobe<span class="w"> </span>-r<span class="w"> </span>null_blk
</pre></div>
</div>
<p>Yielding:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>xnvme_dev:
<span class="w">  </span>xnvme_ident:
<span class="w">    </span>uri:<span class="w"> </span><span class="s1">&#39;/dev/nullb0&#39;</span>
<span class="w">    </span>dtype:<span class="w"> </span>0x3
<span class="w">    </span>nsid:<span class="w"> </span>0x1
<span class="w">    </span>csi:<span class="w"> </span>0x2
<span class="w">  </span>xnvme_be:
<span class="w">    </span>admin:<span class="w"> </span><span class="o">{</span>id:<span class="w"> </span><span class="s1">&#39;block&#39;</span><span class="o">}</span>
<span class="w">    </span>sync:<span class="w"> </span><span class="o">{</span>id:<span class="w"> </span><span class="s1">&#39;block&#39;</span><span class="o">}</span>
<span class="w">    </span>async:<span class="w"> </span><span class="o">{</span>id:<span class="w"> </span><span class="s1">&#39;emu&#39;</span><span class="o">}</span>
<span class="w">    </span>attr:<span class="w"> </span><span class="o">{</span>name:<span class="w"> </span><span class="s1">&#39;linux&#39;</span><span class="o">}</span>
<span class="w">  </span>xnvme_opts:
<span class="w">    </span>be:<span class="w"> </span><span class="s1">&#39;linux&#39;</span>
<span class="w">    </span>mem:<span class="w"> </span><span class="s1">&#39;FIX-ID-VS-MIXIN-NAME&#39;</span>
<span class="w">    </span>dev:<span class="w"> </span><span class="s1">&#39;FIX-ID-VS-MIXIN-NAME&#39;</span>
<span class="w">    </span>admin:<span class="w"> </span><span class="s1">&#39;block&#39;</span>
<span class="w">    </span>sync:<span class="w"> </span><span class="s1">&#39;block&#39;</span>
<span class="w">    </span>async:<span class="w"> </span><span class="s1">&#39;emu&#39;</span>
<span class="w">    </span>oflags:<span class="w"> </span>0x4
<span class="w">  </span>xnvme_geo:
<span class="w">    </span>type:<span class="w"> </span>XNVME_GEO_ZONED
<span class="w">    </span>npugrp:<span class="w"> </span><span class="m">1</span>
<span class="w">    </span>npunit:<span class="w"> </span><span class="m">1</span>
<span class="w">    </span>nzone:<span class="w"> </span><span class="m">1000</span>
<span class="w">    </span>nsect:<span class="w"> </span><span class="m">524288</span>
<span class="w">    </span>nbytes:<span class="w"> </span><span class="m">512</span>
<span class="w">    </span>nbytes_oob:<span class="w"> </span><span class="m">0</span>
<span class="w">    </span>tbytes:<span class="w"> </span><span class="m">268435456000</span>
<span class="w">    </span>mdts_nbytes:<span class="w"> </span><span class="m">65024</span>
<span class="w">    </span>lba_nbytes:<span class="w"> </span><span class="m">512</span>
<span class="w">    </span>lba_extended:<span class="w"> </span><span class="m">0</span>
<span class="w">    </span>ssw:<span class="w"> </span><span class="m">9</span>
</pre></div>
</div>
</section>
<section id="async-i-o-via-libaio">
<h3>Async I/O via <code class="docutils literal notranslate"><span class="pre">libaio</span></code><a class="headerlink" href="#async-i-o-via-libaio" title="Link to this heading">#</a></h3>
<p>When AIO is available then the NVMe NVM Commands for <strong>read</strong> and <strong>write</strong> are
sent over the Linux AIO interface. Doing so improves command-throughput at
higher queue-depths when compared to sending the command over via the NVMe
driver ioctl().</p>
<p>One can explicitly tell <strong>xNVMe</strong> to utilize <code class="docutils literal notranslate"><span class="pre">libaio</span></code> for async I/O by
encoding it in the device identifier, like so:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>xnvme_io_async<span class="w"> </span><span class="nb">read</span><span class="w"> </span>/dev/nvme0n1<span class="w"> </span>--slba<span class="w"> </span>0x0<span class="w"> </span>--qdepth<span class="w"> </span><span class="m">1</span><span class="w"> </span>--async<span class="w"> </span>libaio
</pre></div>
</div>
<p>Yielding the output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Allocating and filling buf of nbytes: 4096</span>
<span class="c1"># Initializing queue and setting default callback function and arguments</span>
<span class="c1"># Read uri: &#39;/dev/nvme0n1&#39;, qd: 1</span>
xnvme_lba_range:
<span class="w">  </span>slba:<span class="w"> </span>0x0000000000000000
<span class="w">  </span>elba:<span class="w"> </span>0x0000000000000000
<span class="w">  </span>naddrs:<span class="w"> </span><span class="m">1</span>
<span class="w">  </span>nbytes:<span class="w"> </span><span class="m">4096</span>
<span class="w">  </span>attr:<span class="w"> </span><span class="o">{</span><span class="w"> </span>is_zones:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>is_valid:<span class="w"> </span><span class="m">1</span><span class="o">}</span>
wall-clock:<span class="w"> </span><span class="o">{</span>elapsed:<span class="w"> </span><span class="m">0</span>.0000,<span class="w"> </span>mib:<span class="w"> </span><span class="m">0</span>.00,<span class="w"> </span>mib_sec:<span class="w"> </span><span class="m">265</span>.77<span class="o">}</span>
<span class="c1"># cb_args: {submitted: 1, completed: 1, ecount: 0}</span>
</pre></div>
</div>
</section>
<section id="async-i-o-via-io-uring">
<h3>Async. I/O via <code class="docutils literal notranslate"><span class="pre">io_uring</span></code><a class="headerlink" href="#async-i-o-via-io-uring" title="Link to this heading">#</a></h3>
<p><strong>xNVMe</strong> utilizes the Linux <strong>io_uring</strong> interface, its support for
feature-probing the <strong>io_uring</strong> interface and the <strong>io_uring</strong> opcodes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">IORING_OP_READ</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IORING_OP_WRITE</span></code></p></li>
</ul>
<p>When available, then <strong>xNVMe</strong> can send the NVMe NVM Commands for <strong>read</strong> and
<strong>write</strong> via the Linux <strong>io_uring</strong> interface. Doing so improves
command-throughput at all io-depths when compared to sending the command via
NVMe Driver IOCTLs and libaio. It also leverages the <strong>io_uring</strong> interface to
enabling I/O polling and kernel-side submission polling.</p>
<p>One can explicitly tell <strong>xNVMe</strong> to utilize <code class="docutils literal notranslate"><span class="pre">io_uring</span></code> for async I/O by
encoding it in the device identifier, like so:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>xnvme_io_async<span class="w"> </span><span class="nb">read</span><span class="w"> </span>/dev/nvme0n1<span class="w"> </span>--slba<span class="w"> </span>0x0<span class="w"> </span>--qdepth<span class="w"> </span><span class="m">1</span><span class="w"> </span>--async<span class="w"> </span>io_uring
</pre></div>
</div>
<p>Yielding the output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Allocating and filling buf of nbytes: 4096</span>
<span class="c1"># Initializing queue and setting default callback function and arguments</span>
<span class="c1"># Read uri: &#39;/dev/nvme0n1&#39;, qd: 1</span>
xnvme_lba_range:
<span class="w">  </span>slba:<span class="w"> </span>0x0000000000000000
<span class="w">  </span>elba:<span class="w"> </span>0x0000000000000000
<span class="w">  </span>naddrs:<span class="w"> </span><span class="m">1</span>
<span class="w">  </span>nbytes:<span class="w"> </span><span class="m">4096</span>
<span class="w">  </span>attr:<span class="w"> </span><span class="o">{</span><span class="w"> </span>is_zones:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>is_valid:<span class="w"> </span><span class="m">1</span><span class="o">}</span>
wall-clock:<span class="w"> </span><span class="o">{</span>elapsed:<span class="w"> </span><span class="m">0</span>.0000,<span class="w"> </span>mib:<span class="w"> </span><span class="m">0</span>.00,<span class="w"> </span>mib_sec:<span class="w"> </span><span class="m">325</span>.17<span class="o">}</span>
<span class="c1"># cb_args: {submitted: 1, completed: 1, ecount: 0}</span>
</pre></div>
</div>
</section>
</section>
<section id="user-space">
<span id="sec-gs-system-config-userspace"></span><h2>User Space<a class="headerlink" href="#user-space" title="Link to this heading">#</a></h2>
<p>Linux provides the <strong>Userspace I/O</strong> ( <a class="reference external" href="https://www.kernel.org/doc/html/v4.14/driver-api/uio-howto.html">uio</a> ) and
<strong>Virtual Function I/O</strong> <a class="reference external" href="https://www.kernel.org/doc/Documentation/vfio.txt">vfio</a> frameworks to write user
space I/ O drivers. Both interfaces work by binding a given device to an
in-kernel stub-driver. The stub-driver in turn exposes device-memory and
device-interrupts to user space. Thus enabling the implementation of device
drivers entirely in user space.</p>
<p>Although Linux provides a capable NVMe Driver with flexible IOCTLs, then a user
space NVMe driver serves those who seek the lowest possible per-command
processing overhead or wants full control over NVMe command construction,
including command-payloads.</p>
<p>Fortunately, you do not need to go and write an user space NVMe driver
since a highly efficient, mature and well-maintained driver already exists.
Namely, the NVMe driver provided by the <strong>Storage Platform Development Kit</strong>
(<a class="reference external" href="https://spdk.io/">SPDK</a>).</p>
<p>Another great fortune is that <strong>xNVMe</strong> bundles the SPDK NVMe Driver with the
<strong>xNVMe</strong> library. So, if you have built and installed <strong>xNVMe</strong> then the
<strong>SPDK</strong> NVMe Driver is readily available to <strong>xNVMe</strong>.</p>
<p>The following subsections goes through a configuration checklist, then shows
how to bind and unbind drivers, and lastly how to utilize non-devfs device
identifiers by enumerating the system and inspecting a device.</p>
<section id="config">
<span id="sec-gs-system-config-userspace-config"></span><h3>Config<a class="headerlink" href="#config" title="Link to this heading">#</a></h3>
<p>What remains is checking your system configuration, enabling IOMMU for use by
the <code class="docutils literal notranslate"><span class="pre">vfio-pci</span></code> driver, and possibly falling back to the <code class="docutils literal notranslate"><span class="pre">uio_pci_generic</span></code>
driver in case <code class="docutils literal notranslate"><span class="pre">vfio-pci</span></code> is not working out.  <code class="docutils literal notranslate"><span class="pre">vfio</span></code> is preferred as
hardware support for IOMMU allows for isolation between devices.</p>
<ol class="arabic simple">
<li><p>Verify that your CPU supports virtualization / VT-d and that it is enabled
in your board BIOS.</p></li>
<li><p>Enable your kernel for an intel CPU then provide the kernel option
<code class="docutils literal notranslate"><span class="pre">intel_iommu=on</span></code>.  If you have a non-Intel CPU then consult documentation
on enabling VT-d / IOMMU for your CPU.</p></li>
<li><p>Increase limits, open <code class="docutils literal notranslate"><span class="pre">/etc/security/limits.conf</span></code> and add:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">*</span>    <span class="n">soft</span> <span class="n">memlock</span> <span class="n">unlimited</span>
<span class="o">*</span>    <span class="n">hard</span> <span class="n">memlock</span> <span class="n">unlimited</span>
<span class="n">root</span> <span class="n">soft</span> <span class="n">memlock</span> <span class="n">unlimited</span>
<span class="n">root</span> <span class="n">hard</span> <span class="n">memlock</span> <span class="n">unlimited</span>
</pre></div>
</div>
<p>Once you have gone through these steps, and rebooted, then this command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>dmesg<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;DMAR: IOMMU&quot;</span>
</pre></div>
</div>
<p>Should output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span><span class="w">    </span><span class="m">0</span>.023467<span class="o">]</span><span class="w"> </span>DMAR:<span class="w"> </span>IOMMU<span class="w"> </span>enabled
</pre></div>
</div>
<p>And this command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>find<span class="w"> </span>/sys/kernel/iommu_groups/<span class="w"> </span>-type<span class="w"> </span>l
</pre></div>
</div>
<p>Should have output similar to:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>/sys/kernel/iommu_groups/7/devices/0000:01:00.0
/sys/kernel/iommu_groups/5/devices/0000:00:05.0
/sys/kernel/iommu_groups/3/devices/0000:00:03.0
/sys/kernel/iommu_groups/1/devices/0000:00:01.0
/sys/kernel/iommu_groups/8/devices/0000:03:00.0
/sys/kernel/iommu_groups/8/devices/0000:02:00.0
/sys/kernel/iommu_groups/6/devices/0000:00:1f.2
/sys/kernel/iommu_groups/6/devices/0000:00:1f.0
/sys/kernel/iommu_groups/6/devices/0000:00:1f.3
/sys/kernel/iommu_groups/4/devices/0000:00:04.0
/sys/kernel/iommu_groups/2/devices/0000:00:02.0
/sys/kernel/iommu_groups/0/devices/0000:00:00.0
</pre></div>
</div>
</section>
<section id="unbinding-and-binding">
<h3>Unbinding and binding<a class="headerlink" href="#unbinding-and-binding" title="Link to this heading">#</a></h3>
<p>With the system configured then you can use the <code class="docutils literal notranslate"><span class="pre">xnvme-driver</span></code> script to bind
and unbind devices. The <code class="docutils literal notranslate"><span class="pre">xnvme-driver</span></code> script is a merge of the <strong>SPDK</strong>
<code class="docutils literal notranslate"><span class="pre">setup.sh</span></code> script and its dependencies.</p>
<p>By running the command below <strong>8GB</strong> of hugepages will be configured, the
Kernel NVMe driver unbound, and <code class="docutils literal notranslate"><span class="pre">vfio-pci</span></code> bound to the device:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">HUGEMEM</span><span class="o">=</span><span class="m">4096</span><span class="w"> </span>xnvme-driver
</pre></div>
</div>
<p>The command above should produce output similar to:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">0000</span>:03:00.0<span class="w"> </span><span class="o">(</span>1b36<span class="w"> </span><span class="m">0010</span><span class="o">)</span>:<span class="w"> </span>nvme<span class="w"> </span>-&gt;<span class="w"> </span>vfio-pci
<span class="m">0000</span>:00:02.0<span class="w"> </span><span class="o">(</span>1af4<span class="w"> </span><span class="m">1001</span><span class="o">)</span>:<span class="w"> </span>Active<span class="w"> </span>mountpoints<span class="w"> </span>on<span class="w"> </span>/dev/vda,<span class="w"> </span>so<span class="w"> </span>not<span class="w"> </span>binding
</pre></div>
</div>
<p>To unbind from <code class="docutils literal notranslate"><span class="pre">vfio-pci</span></code> and back to the Kernel NVMe driver, then run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>xnvme-driver<span class="w"> </span>reset
</pre></div>
</div>
<p>Should output similar to:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">0000</span>:03:00.0<span class="w"> </span><span class="o">(</span>1b36<span class="w"> </span><span class="m">0010</span><span class="o">)</span>:<span class="w"> </span>vfio-pci<span class="w"> </span>-&gt;<span class="w"> </span>nvme
<span class="m">0000</span>:00:02.0<span class="w"> </span><span class="o">(</span>1af4<span class="w"> </span><span class="m">1001</span><span class="o">)</span>:<span class="w"> </span>Already<span class="w"> </span>using<span class="w"> </span>the<span class="w"> </span>virtio-pci<span class="w"> </span>driver
</pre></div>
</div>
</section>
<section id="device-identifiers">
<span id="sec-device-identifiers"></span><h3>Device Identifiers<a class="headerlink" href="#device-identifiers" title="Link to this heading">#</a></h3>
<p>Since the Kernel NVMe driver is unbound from the device, then the kernel no
longer know that the PCIe device is an NVMe device, thus, it no longer lives in
Linux devfs, that is, no longer available in <code class="docutils literal notranslate"><span class="pre">/dev</span></code> as e.g. <code class="docutils literal notranslate"><span class="pre">/dev/nvme0n1</span></code>.</p>
<p>Instead of the filepath in devfs, then you use PCI ids and xNVMe options.</p>
<p>As always, use the <code class="docutils literal notranslate"><span class="pre">xnvme</span></code> cli tool to enumerate devices:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>xnvme<span class="w"> </span>enum
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>xnvme_enumeration:
<span class="w">  </span>-<span class="w"> </span><span class="o">{</span>uri:<span class="w"> </span><span class="s1">&#39;0000:03:00.0&#39;</span>,<span class="w"> </span>dtype:<span class="w"> </span>0x2,<span class="w"> </span>nsid:<span class="w"> </span>0x1,<span class="w"> </span>csi:<span class="w"> </span>0x0<span class="o">}</span>
<span class="w">  </span>-<span class="w"> </span><span class="o">{</span>uri:<span class="w"> </span><span class="s1">&#39;0000:03:00.0&#39;</span>,<span class="w"> </span>dtype:<span class="w"> </span>0x2,<span class="w"> </span>nsid:<span class="w"> </span>0x2,<span class="w"> </span>csi:<span class="w"> </span>0x2<span class="o">}</span>
</pre></div>
</div>
<p>Notice that multiple URIs using the same PCI id but with different <strong>xNVMe</strong>
<code class="docutils literal notranslate"><span class="pre">?opts=&lt;val&gt;</span></code>. This is provided as a means to tell <strong>xNVMe</strong> that you want to
use the NVMe controller at <code class="docutils literal notranslate"><span class="pre">0000:03:00.0</span></code> and the namespace identified by
<code class="docutils literal notranslate"><span class="pre">nsid=1</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>xnvme-driver
xnvme<span class="w"> </span>info<span class="w"> </span><span class="m">0000</span>:03:00.0<span class="w"> </span>--dev-nsid<span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">0000</span>:03:00.0<span class="w"> </span><span class="o">(</span>1b36<span class="w"> </span><span class="m">0010</span><span class="o">)</span>:<span class="w"> </span>Already<span class="w"> </span>using<span class="w"> </span>the<span class="w"> </span>vfio-pci<span class="w"> </span>driver
<span class="m">0000</span>:00:02.0<span class="w"> </span><span class="o">(</span>1af4<span class="w"> </span><span class="m">1001</span><span class="o">)</span>:<span class="w"> </span>Active<span class="w"> </span>mountpoints<span class="w"> </span>on<span class="w"> </span>/dev/vda,<span class="w"> </span>so<span class="w"> </span>not<span class="w"> </span>binding


xnvme_dev:
<span class="w">  </span>xnvme_ident:
<span class="w">    </span>uri:<span class="w"> </span><span class="s1">&#39;0000:03:00.0&#39;</span>
<span class="w">    </span>dtype:<span class="w"> </span>0x2
<span class="w">    </span>nsid:<span class="w"> </span>0x1
<span class="w">    </span>csi:<span class="w"> </span>0x0
<span class="w">  </span>xnvme_be:
<span class="w">    </span>admin:<span class="w"> </span><span class="o">{</span>id:<span class="w"> </span><span class="s1">&#39;nvme&#39;</span><span class="o">}</span>
<span class="w">    </span>sync:<span class="w"> </span><span class="o">{</span>id:<span class="w"> </span><span class="s1">&#39;nvme&#39;</span><span class="o">}</span>
<span class="w">    </span>async:<span class="w"> </span><span class="o">{</span>id:<span class="w"> </span><span class="s1">&#39;nvme&#39;</span><span class="o">}</span>
<span class="w">    </span>attr:<span class="w"> </span><span class="o">{</span>name:<span class="w"> </span><span class="s1">&#39;spdk&#39;</span><span class="o">}</span>
<span class="w">  </span>xnvme_opts:
<span class="w">    </span>be:<span class="w"> </span><span class="s1">&#39;spdk&#39;</span>
<span class="w">    </span>mem:<span class="w"> </span><span class="s1">&#39;FIX-ID-VS-MIXIN-NAME&#39;</span>
<span class="w">    </span>dev:<span class="w"> </span><span class="s1">&#39;FIX-ID-VS-MIXIN-NAME&#39;</span>
<span class="w">    </span>admin:<span class="w"> </span><span class="s1">&#39;nvme&#39;</span>
<span class="w">    </span>sync:<span class="w"> </span><span class="s1">&#39;nvme&#39;</span>
<span class="w">    </span>async:<span class="w"> </span><span class="s1">&#39;nvme&#39;</span>
<span class="w">    </span>oflags:<span class="w"> </span>0x4
<span class="w">  </span>xnvme_geo:
<span class="w">    </span>type:<span class="w"> </span>XNVME_GEO_CONVENTIONAL
<span class="w">    </span>npugrp:<span class="w"> </span><span class="m">1</span>
<span class="w">    </span>npunit:<span class="w"> </span><span class="m">1</span>
<span class="w">    </span>nzone:<span class="w"> </span><span class="m">1</span>
<span class="w">    </span>nsect:<span class="w"> </span><span class="m">2097152</span>
<span class="w">    </span>nbytes:<span class="w"> </span><span class="m">4096</span>
<span class="w">    </span>nbytes_oob:<span class="w"> </span><span class="m">0</span>
<span class="w">    </span>tbytes:<span class="w"> </span><span class="m">8589934592</span>
<span class="w">    </span>mdts_nbytes:<span class="w"> </span><span class="m">524288</span>
<span class="w">    </span>lba_nbytes:<span class="w"> </span><span class="m">4096</span>
<span class="w">    </span>lba_extended:<span class="w"> </span><span class="m">0</span>
<span class="w">    </span>ssw:<span class="w"> </span><span class="m">12</span>
</pre></div>
</div>
<p>Similarly, when using the API, then you would use these URIs instead of
filepaths:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">struct</span> <span class="n">xnvme_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">xnvme_dev_open</span><span class="p">(</span><span class="s2">&quot;pci:0000:01:00.0?nsid=1&quot;</span><span class="p">);</span>
<span class="o">...</span>
</pre></div>
</div>
</section>
</section>
<section id="windows-kernel">
<h2>Windows Kernel<a class="headerlink" href="#windows-kernel" title="Link to this heading">#</a></h2>
<p>Windows 10 or later version is currently preferred as it has all the features
which <strong>xNVMe</strong> utilizes. This section also gives you a brief overview of the
different I/O paths and APIs which the <strong>xNVMe</strong> API unifies access to.</p>
<section id="id1">
<h3>NVMe Driver and IOCTLs<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<p>The default for <strong>xNVMe</strong> is to communicate with devices via the operating
system NVMe driver IOCTLs, specifically on Windows the following are used:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">IOCTL_STORAGE_QUERY_PROPERTY</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOCTL_STORAGE_SET_PROPERTY</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOCTL_STORAGE_REINITIALIZE_MEDIA</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOCTL_SCSI_PASS_THROUGH_DIRECT</span></code></p></li>
</ul>
<p>You can check that this interface is behaving as expected by running:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>xnvme.exe<span class="w"> </span>info<span class="w"> </span><span class="se">\\</span>.<span class="se">\P</span>hysicalDrive0
</pre></div>
</div>
<p>Which should yield output equivalent to:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>xnvme_dev:
<span class="w">  </span>xnvme_ident:
<span class="w">    </span>uri:<span class="w"> </span><span class="s1">&#39;\\.\PhysicalDrive0&#39;</span>
<span class="w">    </span>dtype:<span class="w"> </span>0x2
<span class="w">    </span>nsid:<span class="w"> </span>0x1
<span class="w">    </span>csi:<span class="w"> </span>0x0
<span class="w">    </span>subnqn:<span class="w"> </span><span class="s1">&#39;nqn.1994-11.com.samsung:nvme:980M.2:S649NL0T973010L     &#39;</span>
<span class="w">  </span>xnvme_be:
<span class="w">    </span>admin:<span class="w"> </span><span class="o">{</span>id:<span class="w"> </span><span class="s1">&#39;nvme&#39;</span><span class="o">}</span>
<span class="w">    </span>sync:<span class="w"> </span><span class="o">{</span>id:<span class="w"> </span><span class="s1">&#39;nvme&#39;</span><span class="o">}</span>
<span class="w">    </span>async:<span class="w"> </span><span class="o">{</span>id:<span class="w"> </span><span class="s1">&#39;iocp&#39;</span><span class="o">}</span>
<span class="w">    </span>attr:<span class="w"> </span><span class="o">{</span>name:<span class="w"> </span><span class="s1">&#39;windows&#39;</span><span class="o">}</span>
</pre></div>
</div>
<p>This tells you that <strong>xNVMe</strong> can communicate with the given device identifier
and it informs you that it utilizes <strong>nvme_ioctl</strong> for synchronous command
execution and it uses <strong>iocp</strong> for asynchronous command execution. This method
can be used for raw devices via <strong>\.PhysicalDrive&lt;disk number&gt;</strong> device path.</p>
<p>Below mentioned commands are currently supported by <strong>xNVMe</strong> using IOCTL path:</p>
<ul class="simple">
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">Admin</span> <span class="pre">Commands</span></code></dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">Get</span> <span class="pre">Log</span> <span class="pre">Page</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Identify</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Get</span> <span class="pre">Feature</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Format</span> <span class="pre">NVM</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">I/O</span> <span class="pre">Commands</span></code></dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">Read</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Write</span></code></p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</section>
<section id="nvme-driver-and-regular-file">
<h3>NVMe Driver and Regular File<a class="headerlink" href="#nvme-driver-and-regular-file" title="Link to this heading">#</a></h3>
<p><strong>xNVMe</strong> can communicate with File System mounted devices via the operating
system generic APIs like <strong>ReadFile</strong> and <strong>WriteFile</strong> operations. This method
can be used to do operation on Regular Files.</p>
<p>You can check that this interface is behaving as expected by running:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>xnvme.exe<span class="w"> </span>info<span class="w"> </span>C:<span class="se">\R</span>EADME.md
</pre></div>
</div>
<p>Which should yield output equivalent to:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>xnvme_dev:
<span class="w">  </span>xnvme_ident:
<span class="w">    </span>uri:<span class="w"> </span><span class="s1">&#39;C:\README.md&#39;</span>
<span class="w">    </span>dtype:<span class="w"> </span>0x4
<span class="w">    </span>nsid:<span class="w"> </span>0x1
<span class="w">    </span>csi:<span class="w"> </span>0x1f
<span class="w">    </span>subnqn:<span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">  </span>xnvme_be:
<span class="w">    </span>admin:<span class="w"> </span><span class="o">{</span>id:<span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="o">}</span>
<span class="w">    </span>sync:<span class="w"> </span><span class="o">{</span>id:<span class="w"> </span><span class="s1">&#39;file&#39;</span><span class="o">}</span>
<span class="w">    </span>async:<span class="w"> </span><span class="o">{</span>id:<span class="w"> </span><span class="s1">&#39;iocp&#39;</span><span class="o">}</span>
<span class="w">    </span>attr:<span class="w"> </span><span class="o">{</span>name:<span class="w"> </span><span class="s1">&#39;windows&#39;</span><span class="o">}</span>
</pre></div>
</div>
<p>This tells you that <strong>xNVMe</strong> can communicate with the given regular file
and it informs you that it utilizes <strong>nvme_ioctl</strong> for synchronous command
execution and it uses <strong>iocp</strong> for asynchronous command execution. This method
can be used for file operations via <strong>&lt;driver name&gt;:&lt;file name&gt;</strong> path.</p>
</section>
<section id="async-i-o-via-iocp">
<h3>Async I/O via <code class="docutils literal notranslate"><span class="pre">iocp</span></code><a class="headerlink" href="#async-i-o-via-iocp" title="Link to this heading">#</a></h3>
<p>When AIO is available then the NVMe NVM Commands for <strong>read</strong> and <strong>write</strong> are
sent over the Windows IOCP interface. Doing so improves command-throughput at
higher queue-depths when compared to sending the command via the NVMe driver
ioctl().</p>
<p>One can explicitly tell <strong>xNVMe</strong> to utilize <code class="docutils literal notranslate"><span class="pre">iocp</span></code> for async I/O by
encoding it in the device identifier, like so:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>xnvme_io_async<span class="w"> </span><span class="nb">read</span><span class="w"> </span><span class="se">\\</span>.<span class="se">\P</span>hysicalDrive0<span class="w"> </span>--slba<span class="w"> </span>0x0<span class="w"> </span>--qdepth<span class="w"> </span><span class="m">1</span><span class="w"> </span>--async<span class="w"> </span>iocp
</pre></div>
</div>
<p>Yielding the output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Allocating and filling buf of nbytes: 512</span>
<span class="c1"># Initializing queue and setting default callback function and arguments</span>
<span class="c1"># Read uri: &#39;\\.\PhysicalDrive0&#39;, qd: 1</span>
xnvme_lba_range:
<span class="w">  </span>slba:<span class="w"> </span>0x0000000000000000
<span class="w">  </span>elba:<span class="w"> </span>0x0000000000000000
<span class="w">  </span>naddrs:<span class="w"> </span><span class="m">1</span>
<span class="w">  </span>nbytes:<span class="w"> </span><span class="m">512</span>
<span class="w">  </span>attr:<span class="w"> </span><span class="o">{</span><span class="w"> </span>is_zones:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>is_valid:<span class="w"> </span><span class="m">1</span><span class="o">}</span>
wall-clock:<span class="w"> </span><span class="o">{</span>elapsed:<span class="w"> </span><span class="m">0</span>.0002,<span class="w"> </span>mib:<span class="w"> </span><span class="m">0</span>.00,<span class="w"> </span>mib_sec:<span class="w"> </span><span class="m">2</span>.08<span class="o">}</span>
<span class="c1"># cb_args: {submitted: 1, completed: 1, ecount: 0}</span>
</pre></div>
</div>
</section>
<section id="async-i-o-via-iocp-th">
<h3>Async I/O via <code class="docutils literal notranslate"><span class="pre">iocp_th</span></code><a class="headerlink" href="#async-i-o-via-iocp-th" title="Link to this heading">#</a></h3>
<p>Similar to <code class="docutils literal notranslate"><span class="pre">iocp</span></code> interface, only difference is separate poller is used to
fetch the completed IOs.</p>
<p>One can explicitly tell <strong>xNVMe</strong> to utilize <code class="docutils literal notranslate"><span class="pre">iocp_th</span></code> for async I/O by
encoding it in the device identifier, like so:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>xnvme_io_async<span class="w"> </span><span class="nb">read</span><span class="w"> </span><span class="se">\\</span>.<span class="se">\P</span>hysicalDrive0<span class="w"> </span>--slba<span class="w"> </span>0x0<span class="w"> </span>--qdepth<span class="w"> </span><span class="m">1</span><span class="w"> </span>--async<span class="w"> </span>iocp_th
</pre></div>
</div>
<p>Yielding the output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Allocating and filling buf of nbytes: 512</span>
<span class="c1"># Initializing queue and setting default callback function and arguments</span>
<span class="c1"># Read uri: &#39;\\.\PhysicalDrive0&#39;, qd: 1</span>
xnvme_lba_range:
<span class="w">  </span>slba:<span class="w"> </span>0x0000000000000000
<span class="w">  </span>elba:<span class="w"> </span>0x0000000000000000
<span class="w">  </span>naddrs:<span class="w"> </span><span class="m">1</span>
<span class="w">  </span>nbytes:<span class="w"> </span><span class="m">512</span>
<span class="w">  </span>attr:<span class="w"> </span><span class="o">{</span><span class="w"> </span>is_zones:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>is_valid:<span class="w"> </span><span class="m">1</span><span class="o">}</span>
wall-clock:<span class="w"> </span><span class="o">{</span>elapsed:<span class="w"> </span><span class="m">0</span>.0002,<span class="w"> </span>mib:<span class="w"> </span><span class="m">0</span>.00,<span class="w"> </span>mib_sec:<span class="w"> </span><span class="m">2</span>.14<span class="o">}</span>
<span class="c1"># cb_args: {submitted: 1, completed: 1, ecount: 0}</span>
</pre></div>
</div>
</section>
<section id="async-i-o-via-io-ring">
<h3>Async I/O via <code class="docutils literal notranslate"><span class="pre">io_ring</span></code><a class="headerlink" href="#async-i-o-via-io-ring" title="Link to this heading">#</a></h3>
<p><strong>xNVMe</strong> utilizes the Windows <strong>io_ring</strong> interface, its support for
feature-probing the <strong>io_ring</strong> interface and the <strong>io_ring</strong> opcodes:</p>
<p>When available, then <strong>xNVMe</strong> can send the <strong>io_ring</strong> specific request using
<strong>IORING_HANDLE_REF</strong> and <strong>IORING_BUFFER_REF</strong> structure for <strong>read</strong> and
<strong>write</strong> via Windows <strong>io_ring</strong> interface. Doing so improves command-throughput
at all io-depths when compared to sending the command via NVMe Driver IOCTLs.</p>
<p>One can explicitly tell <strong>xNVMe</strong> to utilize <code class="docutils literal notranslate"><span class="pre">io_ring</span></code> for async I/O by
encoding it in the device identifier, like so:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>xnvme_io_async<span class="w"> </span><span class="nb">read</span><span class="w"> </span><span class="se">\\</span>.<span class="se">\P</span>hysicalDrive0<span class="w"> </span>--slba<span class="w"> </span>0x0<span class="w"> </span>--qdepth<span class="w"> </span><span class="m">1</span><span class="w"> </span>--async<span class="w"> </span>io_ring
</pre></div>
</div>
<p>Yielding the output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Allocating and filling buf of nbytes: 512</span>
<span class="c1"># Initializing queue and setting default callback function and arguments</span>
<span class="c1"># Read uri: &#39;\\.\PhysicalDrive0&#39;, qd: 1</span>
xnvme_lba_range:
<span class="w">  </span>slba:<span class="w"> </span>0x0000000000000000
<span class="w">  </span>elba:<span class="w"> </span>0x0000000000000000
<span class="w">  </span>naddrs:<span class="w"> </span><span class="m">1</span>
<span class="w">  </span>nbytes:<span class="w"> </span><span class="m">512</span>
<span class="w">  </span>attr:<span class="w"> </span><span class="o">{</span><span class="w"> </span>is_zones:<span class="w"> </span><span class="m">0</span>,<span class="w"> </span>is_valid:<span class="w"> </span><span class="m">1</span><span class="o">}</span>
wall-clock:<span class="w"> </span><span class="o">{</span>elapsed:<span class="w"> </span><span class="m">0</span>.0003,<span class="w"> </span>mib:<span class="w"> </span><span class="m">0</span>.00,<span class="w"> </span>mib_sec:<span class="w"> </span><span class="m">1</span>.92<span class="o">}</span>
<span class="c1"># cb_args: {submitted: 1, completed: 1, ecount: 0}</span>
</pre></div>
</div>
</section>
</section>
</section>


                </article>
              
              
              
              
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      Â© Copyright 2024, xNVMe.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.2.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>